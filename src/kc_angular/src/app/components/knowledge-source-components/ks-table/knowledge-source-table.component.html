<!--Copyright 2022 Rob Royce

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.-->


<div style="width: 100%" class="flex-col-center-center">
  <div class="p-card" style="width: 90%; height: 90%">
    <p-table #dataTable
             *ngIf="ksTableShouldExist"
             [value]="ksList"
             [scrollable]="true"
             scrollHeight="60vh"
             [columns]="selectedColumns"
             [hidden]="ksList.length === 0"
             [(contextMenuSelection)]="ksTableContextMenuSelectedKs"
             [selectionPageOnly]="true"
             [(selection)]="ksSelected"
             [contextMenu]="cm"
             [resizableColumns]="false"
             columnResizeMode="expand"
             [globalFilterFields]="ksTableGlobalFilterFields"
             [customSort]="true"
             (sortFunction)="tableSort($event)"
             [paginator]="true"
             [showJumpToPageInput]="true"
             [rows]="25"
             [showCurrentPageReport]="true"
             selectionMode="checkbox"
             dataKey="id.value">
      <ng-template pTemplate="caption">
        <div class="flex-row-center-between">
          <p-multiSelect [options]="KS_TABLE_SUPPORTED_COLUMNS"
                         [(ngModel)]="selectedColumns"
                         (onChange)="onSelectedColumnChange($event)"
                         optionLabel="header"
                         selectedItemsLabel="{0} columns selected"
                         [style]="{minWidth: '200px'}"
                         placeholder="Choose Columns">
          </p-multiSelect>

          <span>
            <div class="p-inputgroup">
              <span class="p-inputgroup-addon"><i class="pi pi-filter"></i></span>
              <input #tableFilter pInputText type="text" (input)="dataTable.filterGlobal(tableFilter.value, 'contains')"
                     placeholder="Filter by title, type, date, etc.">
               <span class="p-inputgroup-addon" (click)="clearFilter(dataTable, tableFilter)"
                     [style.cursor]="tableFilter.value.length ? 'pointer' : 'unset'">
                    <i class="pi pi-times"></i>
              </span>
            </div>
          </span>

          <div class="p-d-flex">
            <button type="button" pButton class="p-button-danger" icon="pi pi-trash"
                    [disabled]="ksSelected.length === 0" style="margin-right: 10px"
                    (click)="removeMultiple(ksSelected)">
            </button>
            <app-ks-export [data]="ksList"></app-ks-export>
            <button type="button" pButton icon="pi pi-cog" style="margin-left: 10px" (click)="op.toggle($event)">
            </button>
          </div>
        </div>
      </ng-template>

      <!--Declare Table Headers-->
      <ng-template pTemplate="header" let-columns>

        <!--        Checkbox Row-->
        <tr>
          <th style="max-width: 40px">
            <p-tableHeaderCheckbox></p-tableHeaderCheckbox>
          </th>
          <th *ngFor="let col of columns"
              [pSortableColumn]="col.field === 'icon' ? '' : col.field"
              [style.max-width]="getColWidth(col)"
              style="width: auto"
              pResizableColumn>
            {{col.header}}
          </th>
        </tr>
      </ng-template>
      <!--End Declare Table Headers-->

      <!--Declare Table Rows-->
      <ng-template pTemplate="body" let-rowData let-columns="columns" let-expanded="expanded">
        <tr [pContextMenuRow]="rowData" (dblclick)="detail(rowData)">
          <td style="max-width: 40px">
            <p-tableCheckbox [value]="rowData" style="margin-right: 10px"></p-tableCheckbox>
          </td>

          <td *ngFor="let col of columns" [style.max-width]="getColWidth(col)" style="width: auto">
            <div *ngIf="col.field === 'icon'">
              <app-ks-icon [ks]="rowData"
                           [style.cursor]="rowData.ingestType === 'file' ? 'grab' : 'default'"
                           draggable="true" id="ks-drag"
                           (dragstart)="onDragStart($event, rowData)">
              </app-ks-icon>
            </div>

            <div *ngIf="col.field === 'title'"
                 class="overflow-hidden"
                 pTooltip="{{rowData.title}}">
              {{rowData.title | truncate: [64]}}
            </div>

            <div *ngIf="col.field === 'associatedProject'"
                 pTooltip="{{rowData[col.field] | projectName}}">
              {{rowData[col.field] | projectName}}
            </div>

            <div *ngIf="col.field === 'dateCreated'">
              <div *ngIf="ksTableShowCountdownInsteadOfDates">
                {{rowData[col.field] | countdown}}
              </div>
              <div *ngIf="!ksTableShowCountdownInsteadOfDates">
                {{rowData[col.field] | date:'mediumDate'}}
              </div>
            </div>

            <div *ngIf="col.field === 'dateDue'">
              <div *ngIf="!rowData[col.field]">
                -
              </div>
              <div *ngIf="rowData[col.field]">
                <div *ngIf="pastDue(rowData[col.field]) else dueDate" style="color: red">
                  <div *ngIf="!ksTableShowCountdownInsteadOfDates">{{rowData[col.field] | date:'mediumDate'}}</div>
                  <div *ngIf="ksTableShowCountdownInsteadOfDates">{{rowData[col.field] | countdown}}</div>
                </div>
                <ng-template #dueDate>
                  <div *ngIf="!ksTableShowCountdownInsteadOfDates">{{rowData[col.field] | date:'mediumDate'}}</div>
                  <div *ngIf="ksTableShowCountdownInsteadOfDates">{{rowData[col.field] | countdown}}</div>
                </ng-template>
              </div>

            </div>

            <div *ngIf="col.field === 'dateModified' || col.field === 'dateAccessed'">
              <div *ngIf="rowData[col.field].length > 0">
                <div *ngIf="ksTableShowCountdownInsteadOfDates">
                  {{rowData[col.field][rowData[col.field].length - 1] | countdown}}
                </div>
                <div *ngIf="!ksTableShowCountdownInsteadOfDates">
                  {{rowData[col.field][rowData[col.field].length - 1] | date:'mediumDate'}}
                </div>
              </div>
              <div *ngIf="rowData[col.field].length === 0">-</div>
            </div>

            <div *ngIf="col.field === 'ingestType'" class="flex-col-center-start" style="width: 100%">
              <i class="pi pi-{{rowData.ingestType | ksIngestTypeIcon}}"></i>
            </div>

            <div *ngIf="col.field === 'flagged'" class="flex-col-center-start" style="width: 100%">
              <p-toggleButton [(ngModel)]="rowData.flagged"
                              onIcon="pi pi-flag" offIcon="pi pi-flag"
                              (onChange)="ksFlagUpdate($event, rowData)">
              </p-toggleButton>
            </div>
          </td>
        </tr>
      </ng-template>
      <!--End Declare Table Rows-->

      <!--Declare Table Summary Row-->
      <ng-template pTemplate="summary">
        <div *ngIf="ksList.length && ksTopics.length">
          Knowledge Source Topics
          <div style="max-height: 5rem; overflow-x: hidden; overflow-y: auto">
            <p-chip *ngFor="let topic of ksTopics"
                    class="cursor-pointer"
                    [style]="{'margin-top': '5px', 'margin-right': '5px', padding: 0}"
                    (click)="onChipClick(topic)">
              <span>
                <button pButton icon="pi pi-search" class="p-button-text p-1"></button>
              </span>
              <span class="pr-3">{{topic}} ({{ksTableTopicCount(topic)}})</span>
            </p-chip>
          </div>
        </div>
      </ng-template>
      <!--End Declare Table Summary Row-->

      <!--Declare Table Paginator-->
      <ng-template let-item pTemplate="paginatordropdownitem">
        {{item.value}} - per page
      </ng-template>
      <!--End Declare Table Paginator-->
    </p-table>
  </div>
</div>

<p-contextMenu #cm
               [model]="ksMenuItems"
               styleClass="shadow-7"
               (onShow)="onKsContextMenu()"
               appendTo="body">
</p-contextMenu>

<p-overlayPanel #op styleClass="surface-100 shadow-7">
  <ng-template pTemplate="content">
    <div>
      <p-toggleButton onLabel="Show Countdown"
                      offLabel="Show Dates"
                      onIcon="pi pi-check"
                      offIcon="pi pi-times"
                      (onChange)="onShowCountdown($event)"
                      [(ngModel)]="ksTableShowCountdownInsteadOfDates">
      </p-toggleButton>
    </div>
    <p-divider></p-divider>
    <div>
      <p-toggleButton onLabel="Show Subproject sources"
                      offLabel="Hide Subproject sources"
                      onIcon="pi pi-check"
                      offIcon="pi pi-times"
                      (onChange)="onShowSubprojects($event)"
                      [(ngModel)]="ksTableAllowSubprojectExpansion">
      </p-toggleButton>
    </div>
    <p-divider></p-divider>
    <div>
      <button pButton
              icon="pi pi-refresh"
              label="Reset Table"
              (click)="resetLayout()">
      </button>
    </div>
  </ng-template>
</p-overlayPanel>
